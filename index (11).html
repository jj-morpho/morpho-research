<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USDC: Risk &amp; Yield Comparison</title>
  <style>
    @import url('https://db.onlinewebfonts.com/c/9419cf3ea65d2c875025a63789ee57fa?family=FK+Grotesk+Variable');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'FK Grotesk Variable', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #DFE1E8;
      color: #1d1d1f;
      min-height: 100vh;
      padding: 48px 20px;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
    }

    /* ── Header ── */
    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1d1d1f;
    }

    /* ── Section ── */
    .section {
      margin-bottom: 32px;
    }

    .section-label {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #86868b;
      margin-bottom: 16px;
    }

    /* ── Yield Cards ── */
    .yield-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .yield-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      border: 1px solid #e5e5ea;
      position: relative;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .yield-card .protocol-name {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .yield-card .vault-label {
      font-size: 13px;
      color: #86868b;
      margin-bottom: 20px;
    }

    .yield-card .apy {
      font-size: 48px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 6px;
    }

    .yield-card .apy-sub {
      font-size: 13px;
      color: #86868b;
      font-weight: 400;
    }

    .yield-card.morpho .protocol-name { color: #2470ff; }
    .yield-card.morpho .apy { color: #2470ff; }
    .yield-card.morpho { border-color: rgba(36, 112, 255, 0.2); }

    .yield-card.aave .protocol-name { color: #7c3aed; }
    .yield-card.aave .apy { color: #7c3aed; }
    .yield-card.aave { border-color: rgba(124, 58, 237, 0.2); }

    /* ── Vault Tabs (scrollable carousel) ── */
    .vault-tabs-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .vault-tabs-wrapper::after {
      content: '';
      position: absolute;
      top: 0; right: 0;
      width: 48px; height: 100%;
      background: linear-gradient(to right, rgba(255,255,255,0), #ffffff 85%);
      pointer-events: none;
      z-index: 1;
      transition: opacity 0.2s ease;
    }

    .vault-tabs-wrapper.scrolled-end::after { opacity: 0; }

    .vault-tabs-wrapper::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 48px; height: 100%;
      background: linear-gradient(to left, rgba(255,255,255,0), #ffffff 85%);
      pointer-events: none;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .vault-tabs-wrapper.scrolled-start::before { opacity: 1; }

    .vault-tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0 2px 4px 2px;
    }

    .vault-tabs::-webkit-scrollbar { display: none; }

    .vault-tab {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 100px;
      border: 1px solid #e5e5ea;
      background: #f5f5f7;
      font-family: inherit;
      font-size: 11px;
      font-weight: 500;
      color: #86868b;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .vault-tab:hover {
      border-color: #c7c7cc;
      color: #1d1d1f;
    }

    .vault-tab.active {
      background: #2470ff;
      border-color: #2470ff;
      color: #ffffff;
    }

    .vault-tab .tab-tvl {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 4px;
    }

    /* ── Morpho card link area ── */
    .morpho-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .morpho-link:hover { opacity: 0.85; }

    /* ── Collateral Section ── */
    .collateral-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .collateral-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 28px;
      border: 1px solid #e5e5ea;
    }

    .collateral-card.morpho { border-color: rgba(36, 112, 255, 0.2); }
    .collateral-card.aave { border-color: rgba(124, 58, 237, 0.2); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .card-header .badge {
      font-size: 11px;
      font-weight: 500;
      color: #86868b;
      background: #f5f5f7;
      padding: 4px 10px;
      border-radius: 100px;
    }

    /* ── Allocation Bar ── */
    .alloc-bar {
      height: 10px;
      border-radius: 5px;
      background: #f0f0f5;
      overflow: hidden;
      display: flex;
      margin-bottom: 20px;
    }

    .alloc-bar .seg {
      height: 100%;
      transition: width 0.4s ease;
    }

    /* ── Asset List ── */
    .asset-list { list-style: none; }

    .asset-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 0;
      border-bottom: 1px solid #f0f0f5;
    }

    .asset-item:last-child { border-bottom: none; }

    a.asset-item {
      text-decoration: none;
      color: inherit;
      border-radius: 6px;
      margin: 0 -8px;
      padding: 9px 8px;
      transition: background 0.15s ease;
    }

    a.asset-item:hover { background: #f5f5f7; }

    a.asset-item + a.asset-item,
    a.asset-item + .asset-item,
    .asset-item + a.asset-item { border-top: none; }

    .asset-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .asset-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .asset-name {
      font-size: 14px;
      font-weight: 500;
      color: #1d1d1f;
    }

    .asset-type {
      font-size: 12px;
      color: #86868b;
      margin-left: 4px;
      font-weight: 400;
    }

    .asset-pct {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1f;
    }

    /* ── Morpho collateral transition ── */
    .morpho-collateral-inner { transition: opacity 0.25s ease; }
    .morpho-collateral-inner.fading { opacity: 0; }

    /* ── Loading ── */
    .loading-text {
      color: #aeaeb2;
      font-size: 13px;
      padding: 12px 0;
    }

    /* ── Footer ── */
    .footer {
      text-align: center;
      margin-top: 40px;
    }

    .footer p {
      font-size: 12px;
      color: #aeaeb2;
    }

    .data-status {
      font-size: 12px;
      color: #aeaeb2;
      margin-top: 6px;
    }

    .data-status .dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      .yield-row, .collateral-row { grid-template-columns: 1fr; }
      .yield-card .apy { font-size: 36px; }
    }
  </style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <div class="header">
    <h1>USDC: Risk &amp; Yield Comparison</h1>
  </div>

  <!-- ── Section 1: Supply Yield ── -->
  <div class="section">
    <div class="section-label">Supply Yield &middot; Real-Time Rates</div>
    <div class="yield-row">

      <!-- Morpho carousel card -->
      <div class="yield-card morpho">
        <div class="vault-tabs-wrapper" id="vaultTabsWrapper">
          <div class="vault-tabs" id="vaultTabs">
            <button class="vault-tab active">Steakhouse USDC</button>
          </div>
        </div>
        <a id="morphoLink" class="morpho-link" href="https://app.morpho.org/ethereum/vault/0xBEEF01735c132Ada46AA9aA4c54623cAA92A64CB/steakhouse-usdc" target="_blank" rel="noopener">
          <div class="protocol-name">Morpho</div>
          <div class="vault-label" id="morphoVaultLabel">Steakhouse USDC</div>
          <div class="apy" id="morphoApy">5.87%</div>
          <div class="apy-sub" id="morphoApySub">Net APY</div>
        </a>
      </div>

      <!-- Aave card -->
      <a href="https://app.aave.com/reserve-overview/?underlyingAsset=0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&marketName=proto_mainnet_v3" class="yield-card aave" style="text-decoration: none; color: inherit;" target="_blank" rel="noopener">
        <div class="protocol-name">Aave V3</div>
        <div class="vault-label">USDC Market</div>
        <div class="apy" id="aaveApy">4.01%</div>
        <div class="apy-sub">Supply APR</div>
      </a>

    </div>
  </div>

  <!-- ── Section 2: Collateral Backing ── -->
  <div class="section">
    <div class="section-label">Collateral Backing</div>
    <div class="collateral-row">

      <!-- Morpho (dynamic) -->
      <div class="collateral-card morpho">
        <div class="morpho-collateral-inner" id="morphoCollateral">
          <div class="card-header">
            <h3>Morpho</h3>
            <span class="badge" id="morphoBadge">Loading&hellip;</span>
          </div>
          <div class="alloc-bar" id="morphoAllocBar"></div>
          <ul class="asset-list" id="morphoAssetList">
            <li class="loading-text">Loading collateral&hellip;</li>
          </ul>
        </div>
      </div>

      <!-- Aave (dynamic — all assets) -->
      <div class="collateral-card aave">
        <div class="card-header">
          <h3>Aave V3</h3>
          <span class="badge" id="aaveBadge">Loading&hellip;</span>
        </div>
        <div class="alloc-bar" id="aaveAllocBar"></div>
        <ul class="asset-list" id="aaveAssetList">
          <li class="loading-text">Loading collateral&hellip;</li>
        </ul>
      </div>

    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>Sources: Morpho Blue API, DefiLlama &middot; Rates update live</p>
    <p class="data-status" id="dataStatus"><span class="dot" style="background:#aeaeb2"></span> Loading live data&hellip;</p>
  </div>

</div>

<script>
  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Configuration
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  const MORPHO_API = 'https://blue-api.morpho.org/graphql';
  const USDC_ADDRESS = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48';

  const COLLATERAL_COLORS = {
    'WETH': '#6366f1', 'weETH': '#818cf8', 'wstETH': '#3b82f6',
    'cbETH': '#3b82f6', 'rETH': '#06b6d4', 'osETH': '#8b5cf6',
    'ETHx': '#818cf8', 'rsETH': '#10b981', 'ezETH': '#06b6d4',
    'tETH': '#60a5fa',
    'WBTC': '#f97316', 'cbBTC': '#f59e0b', 'LBTC': '#f97316',
    'tBTC': '#e11d48', 'eBTC': '#f97316', 'FBTC': '#f97316',
    'USDT': '#22c55e', 'USDC': '#2563eb', 'DAI': '#f59e0b',
    'USDe': '#ec4899', 'sUSDe': '#ec4899', 'eUSDe': '#ec4899',
    'USDtb': '#ec4899', 'USDS': '#22c55e', 'sDAI': '#f59e0b',
    'GHO': '#10b981', 'LUSD': '#6366f1', 'FRAX': '#1d1d1f',
    'PYUSD': '#2563eb', 'crvUSD': '#ef4444', 'EURC': '#2563eb',
    'RLUSD': '#2563eb', 'syrupUSDT': '#22c55e', 'mUSD': '#f97316',
    'USDG': '#2563eb', 'sUSDS': '#f59e0b', 'susds': '#f59e0b',
    'LINK': '#2563eb', 'AAVE': '#9333ea', 'UNI': '#ec4899',
    'MKR': '#818cf8', 'LDO': '#06b6d4', 'CRV': '#ef4444',
    'SNX': '#a78bfa', 'BAL': '#c084fc', 'ENS': '#60a5fa',
    'RPL': '#f97316', 'STG': '#818cf8', 'KNC': '#22c55e',
    'FXS': '#1d1d1f', '1INCH': '#ef4444', 'XAUt': '#f59e0b',
    'ENA': '#ec4899', 'wM': '#22c55e',
    'PT-sUSDe': '#ec4899', 'PT-USDe': '#ec4899', 'PT-eUSDe': '#ec4899',
    'PT-srUSDe': '#ec4899', 'PT-weETH': '#818cf8'
  };

  /* Aave asset addresses for building deep links */
  const AAVE_ADDRESSES = {
    'WETH': '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2',
    'weETH': '0xcd5fe23c85820f7b72d0926fc9b05b43e359b7ee',
    'wstETH': '0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0',
    'WBTC': '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599',
    'cbBTC': '0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf',
    'USDT': '0xdac17f958d2ee523a2206206994597c13d831ec7',
    'USDC': '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
    'USDe': '0x4c9edd5852cd905f086c759e8383e09bff1e68b3',
    'DAI': '0x6b175474e89094c44da98b954eedeac495271d0f',
    'GHO': '0x40d16fc0246ad3160ccc09b8d0d3a2cd28ae6c2f',
    'LINK': '0x514910771af9ca656af840dff83e8264ecf986ca',
    'AAVE': '0x7fc66500c84a76ad7e9c93437bfc5ac33e2ddae9',
    'cbETH': '0xbe9895146f7af43049ca1c1ae358b0541ea49704',
    'rETH': '0xae78736cd615f374d3085123a210448e74fc6393',
    'LUSD': '0x5f98805a4e8be255a32880fdec7f6728c6568ba0',
    'CRV': '0xd533a949740bb3306d119cc777fa900ba034cd52',
    'MKR': '0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2',
    'SNX': '0xc011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f',
    'BAL': '0xba100000625a3754423978a60c9317c58a424e3d',
    'ENS': '0xc18360217d8f7ab5e7c516566761ea12ce7f9d72',
    'UNI': '0x1f9840a85d5af5bf1d1762f925bdaddc4201f984',
    'LDO': '0x5a98fcbea516cf06857215779fd812ca3bef1b32',
    'RPL': '0xd33526068d116ce69f19a9ee46f0bd304f21a51f',
    'FRAX': '0x853d955acef822db058eb8505911ed77f175b99e',
    'FXS': '0x3432b6a60d23ca0dfca7761b7ab56459d9c964d0',
    'KNC': '0xdefa4e8a7bcba345f687a2f1456f5edd9ce97202',
    '1INCH': '0x111111111117dc0aa78b770fa6a738034120c302',
    'STG': '0xaf5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6',
    'sDAI': '0x83f20f44975d03b1b09e64809b757c47f942beea',
    'PYUSD': '0x6c3ea9036406852006290770bedfcaba0e23a0e8',
    'EURC': '0x1abaea1f7c830bd89acc67ec4af516284b1bc33c',
    'osETH': '0xf1c9acdc66974dfb6decb12aa385b9cd01190e38',
    'ETHx': '0xa35b1b31ce002fbf2058d22f30f95d405200a15b',
    'sUSDe': '0x9d39a5de30e57443bff2a8307a4256c8797a3497',
    'USDS': '0xdc035d45d973e3ec169d2276ddab16f1e407384f',
    'tBTC': '0x18084fba666a33d37592fa2633fd49a74dd93a88',
    'rsETH': '0xa1290d69c65a6fe4df752f95823fae25cb99e5a7',
    'ezETH': '0xbf5495efe5db9ce00f80364c8b423567e58d2110',
    'LBTC': '0x8236a87084f8b84306f72007f36f2618a5634494',
    'crvUSD': '0xf939e0a03fb07f59a73314e73794be0e57ac1b4e',
    'XAUt': '0x68749665ff8d2d112fa859aa293f07a622782f38',
    'RLUSD': '0x65d6a1d2e6c5be60cb3ec3ede850f2f5c5bbe7b5',
    'syrupUSDT': '0x7ae0ab56312d1a05e47236E802132a1d08aa8415',
    'USDtb': '0xc139ba0ea06fc3d8dd88d3e16ac0e7a23e29e2cd',
    'eUSDe': '0x90dc996446a5e8a872e26e3e2d3be7ddcd2e8aaf',
    'mUSD': '0x866a2bf4e572cbcf37d5071a7a58503bfb36be1b',
    'USDG': '0x0a7a23c4ebcb30dac2a6ee5e3e9be1a22b302b05',
    'eBTC': '0x657e8c867d8b37dcc18fa4caead9c45eb088c642',
    'FBTC': '0xc96de26018a54d51c097160568752c4e3bd6c364',
    'tETH': '0xd46ba6d942050d489dbd938a2c909a5d5039a161'
  };

  /* Short labels for known assets */
  const ASSET_LABELS = {
    'WETH': 'Wrapped ETH', 'weETH': 'EtherFi Restaked ETH', 'wstETH': 'Lido Staked ETH',
    'cbETH': 'Coinbase Staked ETH', 'rETH': 'Rocket Pool ETH', 'osETH': 'Stakewise ETH',
    'ETHx': 'Stader ETH', 'rsETH': 'Kelp Restaked ETH', 'ezETH': 'Renzo Restaked ETH',
    'tETH': 'Treehouse ETH',
    'WBTC': 'Wrapped BTC', 'cbBTC': 'Coinbase BTC', 'LBTC': 'Lombard BTC',
    'tBTC': 'Threshold BTC', 'eBTC': 'ether.fi BTC', 'FBTC': 'Fire BTC',
    'USDT': 'Tether', 'USDC': 'USD Coin', 'DAI': 'MakerDAO',
    'USDe': 'Ethena Synthetic', 'sUSDe': 'Staked USDe', 'eUSDe': 'Ethena eUSDe',
    'USDtb': 'Ethena USDtb', 'USDS': 'Sky Dollar', 'sDAI': 'Savings Dai',
    'GHO': 'Aave Stablecoin', 'LUSD': 'Liquity USD', 'FRAX': 'Frax',
    'PYUSD': 'PayPal USD', 'crvUSD': 'Curve USD', 'EURC': 'Circle Euro',
    'RLUSD': 'Ripple USD', 'syrupUSDT': 'Maple Syrup USDT', 'mUSD': 'MetaMask USD',
    'USDG': 'Paxos Global Dollar', 'sUSDS': 'Savings USDS',
    'LINK': 'Chainlink', 'AAVE': 'Aave Token', 'UNI': 'Uniswap',
    'MKR': 'Maker', 'LDO': 'Lido DAO', 'CRV': 'Curve',
    'SNX': 'Synthetix', 'BAL': 'Balancer', 'ENS': 'Ethereum Name Service',
    'RPL': 'Rocket Pool', 'STG': 'Stargate', 'KNC': 'Kyber Network',
    'FXS': 'Frax Share', '1INCH': '1inch', 'XAUt': 'Tether Gold',
    'ENA': 'Ethena'
  };

  let morphoVaults = [];
  let currentVault = 0;

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Helpers
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  function formatTvl(usd) {
    if (usd >= 1e9) return '$' + (usd / 1e9).toFixed(1) + 'B';
    if (usd >= 1e6) return '$' + (usd / 1e6).toFixed(1) + 'M';
    if (usd >= 1e3) return '$' + (usd / 1e3).toFixed(0) + 'K';
    return '$' + Math.round(usd);
  }

  function setStatus(color, text) {
    document.getElementById('dataStatus').innerHTML =
      '<span class="dot" style="background:' + color + '"></span> ' + text;
  }

  /* Stable color for any symbol */
  function colorFor(sym) {
    if (COLLATERAL_COLORS[sym]) return COLLATERAL_COLORS[sym];
    // Pendle PT tokens
    if (sym.startsWith('PT-') || sym.startsWith('PT_')) return '#ec4899';
    // Hash fallback
    let h = 0;
    for (let i = 0; i < sym.length; i++) h = sym.charCodeAt(i) + ((h << 5) - h);
    const palette = ['#6366f1','#3b82f6','#06b6d4','#10b981','#22c55e','#f59e0b','#f97316','#ef4444','#ec4899','#8b5cf6','#818cf8','#a78bfa'];
    return palette[Math.abs(h) % palette.length];
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Fetch ALL USDC vaults from Morpho
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  async function fetchAllMorphoVaults() {
    let allItems = [];
    let skip = 0;
    const pageSize = 100;

    while (true) {
      const query = `{
        vaults(
          first: ${pageSize}
          skip: ${skip}
          orderBy: TotalAssetsUsd
          orderDirection: Desc
          where: {
            chainId_in: [1]
            assetAddress_in: ["${USDC_ADDRESS}"]
            whitelisted: true
          }
        ) {
          items {
            address
            name
            symbol
            state {
              netApy
              fee
              totalAssetsUsd
              allocation {
                supplyAssetsUsd
                market {
                  uniqueKey
                  collateralAsset { symbol name }
                }
              }
            }
          }
          pageInfo { count countTotal }
        }
      }`;

      const res = await fetch(MORPHO_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if (json.errors) throw new Error(json.errors[0].message);

      const data = json.data.vaults;
      allItems = allItems.concat(data.items);

      if (allItems.length >= data.pageInfo.countTotal || data.items.length < pageSize) break;
      skip += pageSize;
    }

    return allItems;
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Process Morpho vault
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  function processVault(raw) {
    const state = raw.state || {};
    const apy = state.netApy != null ? (state.netApy * 100).toFixed(2) + '%' : '\u2014';
    const tvl = state.totalAssetsUsd || 0;
    const fee = state.fee != null ? state.fee : null;

    let apySub = 'Net APY';
    if (fee != null && fee > 0) {
      apySub = 'Net APY (post ' + Math.round(fee * 100) + '% perf. fee)';
    }

    const alloc = state.allocation || [];
    const totalUsd = alloc.reduce((s, a) => s + (parseFloat(a.supplyAssetsUsd) || 0), 0);
    let collateral = [];

    if (totalUsd > 0) {
      collateral = alloc
        .filter(a => a.market && a.market.collateralAsset)
        .map(a => {
          const pct = (parseFloat(a.supplyAssetsUsd) || 0) / totalUsd * 100;
          const sym = a.market.collateralAsset.symbol;
          const key = a.market.uniqueKey;
          return {
            name: sym,
            type: a.market.collateralAsset.name || sym,
            pct: pct < 0.1 ? '<0.1%' : pct.toFixed(1) + '%',
            width: Math.max(pct, 0.3),
            color: colorFor(sym),
            url: key ? 'https://app.morpho.org/ethereum/market/' + key : null
          };
        })
        .sort((a, b) => b.width - a.width);
    }

    const badge = collateral.length > 0
      ? collateral.length + ' assets \u00b7 Isolated Markets'
      : 'No active markets';

    return {
      address: raw.address,
      name: raw.name || raw.symbol || raw.address.slice(0, 10),
      url: 'https://app.morpho.org/ethereum/vault/' + raw.address,
      apy, apySub, tvl, badge, collateral
    };
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Build tabs (horizontal scroll carousel)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  function buildTabs() {
    const container = document.getElementById('vaultTabs');
    container.innerHTML = '';
    morphoVaults.forEach((v, i) => {
      const btn = document.createElement('button');
      btn.className = 'vault-tab' + (i === 0 ? ' active' : '');
      btn.textContent = v.name;
      btn.onclick = () => selectVault(i);
      container.appendChild(btn);
    });
    container.addEventListener('scroll', updateFadeClasses);
    updateFadeClasses();
  }

  function updateFadeClasses() {
    const tabs = document.getElementById('vaultTabs');
    const wrapper = document.getElementById('vaultTabsWrapper');
    if (!tabs || !wrapper) return;
    const atEnd = tabs.scrollLeft + tabs.clientWidth >= tabs.scrollWidth - 2;
    const atStart = tabs.scrollLeft <= 2;
    wrapper.classList.toggle('scrolled-end', atEnd);
    wrapper.classList.toggle('scrolled-start', !atStart);
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Select vault
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  function selectVault(index) {
    if (index === currentVault && morphoVaults.length > 1) return;
    currentVault = index;
    const v = morphoVaults[index];

    document.querySelectorAll('.vault-tab').forEach((tab, i) => {
      tab.classList.toggle('active', i === index);
    });

    const activeTab = document.querySelectorAll('.vault-tab')[index];
    if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });

    document.getElementById('morphoLink').href = v.url;
    document.getElementById('morphoVaultLabel').textContent = v.name;
    document.getElementById('morphoApy').textContent = v.apy;
    document.getElementById('morphoApySub').textContent = v.apySub;

    const inner = document.getElementById('morphoCollateral');
    inner.classList.add('fading');
    setTimeout(() => {
      renderMorphoCollateral(v);
      inner.classList.remove('fading');
    }, 200);
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Render Morpho collateral
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  function renderMorphoCollateral(v) {
    document.getElementById('morphoBadge').textContent = v.badge;

    const bar = document.getElementById('morphoAllocBar');
    bar.innerHTML = v.collateral.map(a =>
      '<div class="seg" style="width:' + a.width + '%;background:' + a.color + '"></div>'
    ).join('');

    const list = document.getElementById('morphoAssetList');
    if (v.collateral.length === 0) {
      list.innerHTML = '<li class="loading-text">No active collateral markets</li>';
      return;
    }

    list.innerHTML = v.collateral.map(a => {
      const tag = a.url ? 'a' : 'li';
      const href = a.url ? ' href="' + a.url + '" target="_blank" rel="noopener"' : '';
      return '<' + tag + ' class="asset-item"' + href + '>' +
        '<div class="asset-left">' +
          '<span class="asset-dot" style="background:' + a.color + '"></span>' +
          '<span class="asset-name">' + a.name + ' <span class="asset-type">' + a.type + '</span></span>' +
        '</div>' +
        '<span class="asset-pct">' + a.pct + '</span>' +
      '</' + tag + '>';
    }).join('');
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Fetch & render Aave — ALL collateral assets
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  async function fetchAaveData() {
    const res = await fetch('https://yields.llama.fi/pools');
    if (!res.ok) throw new Error('DeFi Llama HTTP ' + res.status);
    const json = await res.json();

    /* Filter Aave V3 Ethereum pools */
    const aavePools = json.data.filter(p =>
      p.project === 'aave-v3' && p.chain === 'Ethereum' && p.tvlUsd > 0
    );

    /* Update USDC supply APR */
    const usdcPool = aavePools.find(p => p.symbol === 'USDC');
    if (usdcPool && usdcPool.apyBase != null) {
      document.getElementById('aaveApy').textContent = usdcPool.apyBase.toFixed(2) + '%';
    }

    /* Build collateral list from all pools (every supplied asset = potential collateral) */
    const totalTvl = aavePools.reduce((s, p) => s + p.tvlUsd, 0);
    const assets = aavePools
      .map(p => {
        /* DeFi Llama symbols sometimes have suffixes */
        let sym = p.symbol.split('-')[0].trim();
        const pct = (p.tvlUsd / totalTvl) * 100;
        /* Use hardcoded address, fall back to DeFi Llama's underlyingTokens */
        const addr = AAVE_ADDRESSES[sym]
          || (p.underlyingTokens && p.underlyingTokens[0]
              ? p.underlyingTokens[0].toLowerCase() : null);
        return {
          symbol: sym,
          label: ASSET_LABELS[sym] || sym,
          pct: pct,
          pctStr: pct < 0.01 ? '<0.01%' : pct < 0.1 ? '<0.1%' : pct.toFixed(1) + '%',
          tvl: p.tvlUsd,
          color: colorFor(sym),
          address: addr
        };
      })
      .sort((a, b) => b.tvl - a.tvl);

    return { assets, totalTvl };
  }

  function renderAaveCollateral(assets, totalTvl) {
    const badge = document.getElementById('aaveBadge');
    badge.textContent = assets.length + ' assets \u00b7 Shared pool';

    /* Allocation bar — show top 10, rest grouped */
    const bar = document.getElementById('aaveAllocBar');
    const barAssets = assets.slice(0, 10);
    const restPct = assets.slice(10).reduce((s, a) => s + a.pct, 0);
    let barHtml = barAssets.map(a =>
      '<div class="seg" style="width:' + a.pct + '%;background:' + a.color + '"></div>'
    ).join('');
    if (restPct > 0) {
      barHtml += '<div class="seg" style="width:' + restPct + '%;background:#c7c7cc"></div>';
    }
    bar.innerHTML = barHtml;

    /* Full asset list — ALL of them, no "Others" */
    const list = document.getElementById('aaveAssetList');
    list.innerHTML = assets.map(a => {
      const addr = a.address;
      if (addr) {
        return '<a class="asset-item" href="https://app.aave.com/reserve-overview/?underlyingAsset=' + addr + '&marketName=proto_mainnet_v3" target="_blank" rel="noopener">' +
          '<div class="asset-left">' +
            '<span class="asset-dot" style="background:' + a.color + '"></span>' +
            '<span class="asset-name">' + a.symbol + ' <span class="asset-type">' + a.label + '</span></span>' +
          '</div>' +
          '<span class="asset-pct">' + a.pctStr + '</span>' +
        '</a>';
      }
      return '<li class="asset-item">' +
        '<div class="asset-left">' +
          '<span class="asset-dot" style="background:' + a.color + '"></span>' +
          '<span class="asset-name">' + a.symbol + ' <span class="asset-type">' + a.label + '</span></span>' +
        '</div>' +
        '<span class="asset-pct">' + a.pctStr + '</span>' +
      '</li>';
    }).join('');
  }

  /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     Init
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

  (async function init() {
    let morphoOk = false;
    let aaveOk = false;

    const [morphoResult, aaveResult] = await Promise.allSettled([
      fetchAllMorphoVaults(),
      fetchAaveData()
    ]);

    /* Morpho */
    if (morphoResult.status === 'fulfilled') {
      const raw = morphoResult.value;
      morphoVaults = raw.map(processVault);
      /* Sort: bluechip (few collaterals, high deposits) left → long tail (many collaterals) right */
      morphoVaults.sort((a, b) => {
        const colDiff = a.collateral.length - b.collateral.length;
        if (colDiff !== 0) return colDiff;
        return b.tvl - a.tvl;
      });
      morphoOk = true;

      buildTabs();
      if (morphoVaults.length > 0) {
        selectVault(0);
      }
    } else {
      console.error('[Morpho]', morphoResult.reason);
      document.getElementById('vaultTabs').innerHTML =
        '<span class="loading-text">Failed to load vaults. Refresh to retry.</span>';
    }

    /* Aave */
    if (aaveResult.status === 'fulfilled') {
      const { assets, totalTvl } = aaveResult.value;
      renderAaveCollateral(assets, totalTvl);
      aaveOk = true;
    } else {
      console.error('[Aave/DeFi Llama]', aaveResult.reason);
    }

    /* Status */
    if (morphoOk && aaveOk) {
      setStatus('#22c55e', 'Live data \u00b7 Updated just now');
    } else if (morphoOk || aaveOk) {
      setStatus('#f59e0b', 'Partial live data \u00b7 Some sources unavailable');
    } else {
      setStatus('#aeaeb2', 'Unable to load data \u00b7 Please refresh');
    }
  })();
</script>

</body>
</html>
